function _defineProperty(obj,key,value){if(key in obj){Object.defineProperty(obj,key,{value:value,enumerable:true,configurable:true,writable:true});}else{obj[key]=value;}return obj;}function _objectSpread(target){for(var i=1;i<arguments.length;i++){var source=arguments[i]!=null?arguments[i]:{};var ownKeys=Object.keys(source);if(typeof Object.getOwnPropertySymbols==="function"){ownKeys=ownKeys.concat(Object.getOwnPropertySymbols(source).filter(function(sym){return Object.getOwnPropertyDescriptor(source,sym).enumerable;}));}ownKeys.forEach(function(key){_defineProperty(target,key,source[key]);});}return target;}var STD={macro:{rec:function(variation){return function(record){return _objectSpread({variation:variation,pipe:function(f){return f(this);}},record);};}},audio_wingflaps:List('./audio/wingflap_0.mp3','./audio/wingflap_1.mp3','./audio/wingflap_2.mp3','./audio/wingflap_3.mp3','./audio/wingflap_4.mp3','./audio/wingflap_5.mp3'),audio_meows:List('./audio/meow_0.mp3','./audio/meow_1.mp3','./audio/meow_2.mp3','./audio/meow_loud_lq_0.mp3'),aspect_ratio:9/16,refresh_rate:15,resizing_speed:0.15,bg_speed:0.5,ground_hitbox_y:0.9,pipe:{width:0.25,space_vert:0.2,space_hort:0.8,padding:0.25,speed:0.0125},player:{gravity_strength:0.0005,jump_strength:0.012,max_lift:0.006,max_drop:0.015,drag:0.9,hitbox_dx:0.05,hitbox_dy:0.01,hitbox_w:0.1,hitbox_h:0.04,x:0.05,speed:0.015},trans:{StartToGame:0.05,GameToGameOver:0.025,GameOverToStart:0.02,ktf_StartToGame:function(t){return Math.pow(t,2);},ktf_GameToGameOver:function(t){return Math.pow(t,3);},ktf_GameOverToStart:function(t){return 1.1*(t**2-0.5)+0.5;}}};var Global=STD.macro.rec('Global');var Start=STD.macro.rec('Start');var StartToGame=STD.macro.rec('StartToGame');var Game=STD.macro.rec('Game');var GameToGameOver=STD.macro.rec('GameToGameOver');var GameOver=STD.macro.rec('GameOver');var GameOverToStart=STD.macro.rec('GameOverToStart');var Player=STD.macro.rec('Player');var idealCanvasWidth=windowDimensions.fmap(v2ToPair).fmap(mapSnd(mul(STD.aspect_ratio))).fmap(uncurry(min)).fmap(minus(15));var setCanvasWidthProportionally=function(width){return setCanvasDimensions(width)(width/STD.aspect_ratio);};var jumpPlayer=function(player){return Player({rotation:player.rotation,y:player.vy-STD.player.jump_strength+player.y,vy:player.vy-STD.player.jump_strength});};var pullPlayer=function(player){return Player({rotation:lerp(0.5)(player.rotation)(player.vy*4-0.015),y:player.y+player.vy,vy:player.vy>STD.player.max_drop?STD.player.max_drop:player.vy< -STD.player.max_lift?player.vy*STD.player.drag:player.vy+STD.player.gravity_strength});};var isCollision=function(player){return function(pipeX){return function(pipeY){if(player.y+STD.player.hitbox_dy>STD.ground_hitbox_y)return true;else{var _kx=pipeX-STD.player.x-STD.player.hitbox_dx;var _ky=pipeY-player.y-STD.player.hitbox_dy;return _kx<STD.player.hitbox_w&&_kx> -STD.pipe.width&&(_ky>STD.pipe.space_vert||_ky<STD.player.hitbox_h);}};};};var initialStart=Start({distance:0,player:Player({rotation:0,y:0.5,vy:0})});var main=Do_IO.side(STD.audio_wingflaps.link(STD.audio_meows).fmap(loadAudio).pipe(execute_IO)).side(loadImage('./image/bg_flappybird.png')).side(loadImage('./image/grass_sideview.png')).side(loadImage('./image/ralph_flappybird.png')).side(loadImage('./image/pipe_flappybird.png')).side(loadFont('./font/FlappyBird.ttf')).bindto('presentTime')(function(_){return time;}).bindto('initialCanvasWidth')(function(_){return idealCanvasWidth;}).call(function($){return setCanvasWidthProportionally($.initialCanvasWidth);}).bind(function($){return loop(Global({isResizing:false,isRefresh:false,counter:0,refreshCounter:0,canvasWidth:$.initialCanvasWidth,time:$.presentTime}))(initialStart);});var loop=function(global){return function(local){return Do_IO.bindto('presentTime')(function(_){return time;}).bindto('currentIdealCanvasWidth')(function(_){return idealCanvasWidth;}).bindto('isCurrentlyResizing')(function($){return global.isResizing&&diff(global.canvasWidth)($.currentIdealCanvasWidth)>10?send(true):isWindowResized;}).fmapto('deltaTime')(function($){return $.presentTime-global.time;}).fmapto('nextRefreshCounter')(function($){return global.refreshCounter>STD.refresh_rate?$.deltaTime:global.refreshCounter+$.deltaTime;}).fmapto('isCurrentlyRefreshing')(function($){return $.nextRefreshCounter>STD.refresh_rate;}).fmapto('nextGlobal')(function($){return Global({isResizing:$.isCurrentlyResizing,isRefresh:$.isCurrentlyRefreshing,time:$.presentTime,refreshCounter:$.nextRefreshCounter,counter:global.counter+$.deltaTime,canvasWidth:$.isCurrentlyResizing&&$.isCurrentlyRefreshing?lerp(STD.resizing_speed)(global.canvasWidth)($.currentIdealCanvasWidth):global.canvasWidth});}).bindto('nextLocal')(function($){return update($.nextGlobal)(local);}).call(function($){return $.isCurrentlyResizing&&$.isCurrentlyRefreshing?setCanvasWidthProportionally($.nextGlobal.canvasWidth):idle;}).call(function($){return render($.nextLocal);}).call(function($){return $.nextGlobal.isRefresh?refreshBuffer:idle;}).bind(function($){return queueIO(loop($.nextGlobal)($.nextLocal));});};};var update=function(global){return function(local){return local.variation==='Start'?keyboardKey('Space').fmap(eq('toDown')).call(function(isSpaceDown){return isSpaceDown?trigger_wingflap:idle;}).fmap(function(isSpaceDown){return isSpaceDown?StartToGame({counter:0,keytime:STD.trans.ktf_StartToGame(0),distance:local.distance,player:jumpPlayer(local.player)}):global.isRefresh?iterate_Start(local):local;}):local.variation==='StartToGame'?local.pipe(global.isRefresh?update_StartToGame:send):local.variation==='Game'?global.isRefresh?Do_IO.bindto('nextPlayer')(function(_){return update_player(local.player);}).fmapto('isCollided')(function($){return isCollision($.nextPlayer)(local.pipeX)(head(local.pipeYs));}).call(function($){return $.isCollided?trigger_gameover:idle;}).fmap(function($){return $.isCollided?GameToGameOver({counter:0,keytime:STD.trans.ktf_GameToGameOver(0),failGame:local}):local.pipeX< -STD.pipe.width?Game({player:$.nextPlayer,distance:local.distance+STD.player.speed,pipeX:local.pipeX-STD.pipe.speed+STD.pipe.space_hort,pipeYs:tail(local.pipeYs),score:local.score+1}):Game({player:$.nextPlayer,distance:local.distance+STD.player.speed,pipeX:local.pipeX-STD.pipe.speed,pipeYs:local.pipeYs,score:local.score});}):send(local):local.variation==='GameToGameOver'?local.pipe(global.isRefresh?iterate_GameToGameOver:id).pipe(send):local.variation==='GameOver'?keyboardKey('Space').fmap(function(spaceState){return isButtonDown(spaceState)?GameOverToStart({failGame:local.failGame,newStart:initialStart,counter:0,keytime:STD.trans.ktf_GameOverToStart(0)}):local;}):local.variation==='GameOverToStart'?local.pipe(global.isRefresh?iterate_GameOverToStart:id).pipe(send):never;};};var render=function(local){return local.variation==='Start'?executing(setActiveLayer(1),clearLayer,render_bg(local.distance*STD.bg_speed),render_player(local.player),render_title(0.1),render_fg(local.distance)):local.variation==='StartToGame'?executing(setActiveLayer(1),clearLayer,render_bg(local.distance*STD.bg_speed),render_player(local.player),render_title(lerp(local.keytime)(0.1)(-0.1)),render_score(0)(lerp(local.keytime)(-0.1)(0.1)),render_fg(local.distance)):local.variation==='Game'?executing(setActiveLayer(1),clearLayer,render_bg(local.distance*STD.bg_speed),render_Game_wo_score(local),render_score(local.score)(0.1),render_fg(local.distance)):local.variation==='GameToGameOver'&&local.failGame.variation==='Game'?executing(setActiveLayer(1),clearLayer,render_bg(local.failGame.distance*STD.bg_speed),render_Game_wo_score(local.failGame),render_gameoverText(lerp(local.keytime)(-0.5)(0.5)),render_score(local.failGame.score)(lerp(local.keytime)(0.1)(0.6)),render_fg(local.failGame.distance)):local.variation==='GameOver'&&local.failGame.variation==='Game'?executing(setActiveLayer(1),clearLayer,render_bg(local.failGame.distance*STD.bg_speed),render_Game_wo_score(local.failGame),render_gameoverText(0.5),render_score(local.failGame.score)(0.6),render_fg(local.failGame.distance)):local.variation==='GameOverToStart'&&local.failGame.variation==='Game'&&local.newStart.variation==='Start'?executing(setActiveLayer(1),clearLayer,saveLayerState,beginPath,n_relocateTo(0)(local.keytime),n_lineTo(1)(local.keytime),n_lineTo(1)(1),n_lineTo(0)(1),closePath,clipEvenOdd,render_bg(local.failGame.distance*STD.bg_speed),render_Game_wo_score(local.failGame),render_gameoverText(0.5),render_score(local.failGame.score)(0.6),render_fg(local.failGame.distance),restoreLayerState,saveLayerState,beginPath,n_relocateTo(0)(0),n_lineTo(1)(0),n_lineTo(1)(local.keytime),n_lineTo(0)(local.keytime),closePath,clipEvenOdd,render_bg(local.newStart.distance*STD.bg_speed),render_player(local.newStart.player),render_title(0.1),render_fg(local.newStart.distance),restoreLayerState,n_setLineThickness(0.05),beginPath,n_relocateTo(0)(local.keytime),n_lineTo(1)(local.keytime),stroke):never;};var iterate_Start=function(local){return local.variation==='Start'?Start({distance:local.distance+STD.player.speed,player:local.player.pipe(local.player.y>0.6?jumpPlayer:pullPlayer)}):never;};var iterate_GameToGameOver=function(local){return local.variation==='GameToGameOver'?local.counter<1?GameToGameOver({failGame:local.failGame,keytime:STD.trans.ktf_GameToGameOver(local.counter),counter:local.counter+STD.trans.GameToGameOver}):GameOver({failGame:local.failGame}):never;};var iterate_GameOverToStart=function(local){return local.variation==='GameOverToStart'?local.counter<1?GameOverToStart({failGame:local.failGame,newStart:iterate_Start(local.newStart),keytime:STD.trans.ktf_GameOverToStart(local.counter),counter:local.counter+STD.trans.GameOverToStart}):local.newStart:never;};var update_player=function(player){return keyboardKey('Space').fmap(eq('toDown')).call(function(isSpacePressed){return isSpacePressed?trigger_wingflap:idle;}).fmap(function(isSpacePressed){return isSpacePressed?jumpPlayer(player):pullPlayer(player);});};var update_StartToGame=function(local){return local.variation==='StartToGame'?local.counter<1?update_player(local.player).fmap(function(player){return StartToGame({counter:local.counter+STD.trans.StartToGame,keytime:STD.trans.ktf_StartToGame(local.counter),distance:local.distance+STD.player.speed,player:player});}):randomSeedIO.fmap(function(seed){return Game({player:local.player,distance:local.distance,pipeX:1,pipeYs:repeatProcess(randomFloatRange(STD.pipe.padding)(1-STD.pipe.padding)).computation(seed).snd,score:0});}):never;};var render_Game_wo_score=function(local){return local.variation==='Game'?executing(render_player(local.player),render_pipe(local.pipeX)(at(0)(local.pipeYs)),render_pipe(local.pipeX+STD.pipe.space_hort)(at(1)(local.pipeYs))):never;};var render_player=function(player){return executing(saveLayerState,n_translateLayer(STD.player.x)(player.y),n_rotateLayer(player.rotation),n_fullScaledImage('./image/ralph_flappybird.png')(0.2)(0)(0),restoreLayerState);};var render_title=function(y){return executing(setToCenteredTextStyle,n_setLineThickness(0.03),n_setFontSize(0.15),setFontFamily('FlappyBird'),setStrokeColor('Black'),setFillColor('White'),n_strokeFillText("Floppy Ralph")(0.5)(y));};var render_pipe=function(x){return function(y){return executing(saveLayerState,n_fullScaledImage('./image/pipe_flappybird.png')(STD.pipe.width)(x)(y),scaleLayerAxisY(-1),n_fullScaledImage('./image/pipe_flappybird.png')(STD.pipe.width)(x)(STD.pipe.space_vert-y),restoreLayerState);};};var render_score=function(score){return function(y){return executing(n_setFontSize(0.1),n_setLineThickness(0.02),n_strokeFillText(show(score))(0.5)(y));};};var render_gameoverText=function(y){return executing(n_setFontSize(0.15),n_setLineThickness(0.03),setFontFamily('FlappyBird'),setFillColor('White'),setStrokeColor('Black'),setToCenteredTextStyle,n_strokeFillText("Game Over")(0.5)(y));};var render_bg=function(x){return Do_IO.bindto('bgImgAspectRatio')(function(_){return n_imageAspectRatio('./image/bg_flappybird.png');}).fmapto('bgX')(function($){return -x%$.bgImgAspectRatio;}).call(function($){return n_fullScaledImage('./image/bg_flappybird.png')($.bgImgAspectRatio)($.bgX)(0);}).bind(function($){return n_fullScaledImage('./image/bg_flappybird.png')($.bgImgAspectRatio)($.bgX+$.bgImgAspectRatio-0.001)(0);});};var render_fg=function(x){return Do_IO.fmapto('fgX')(function(_){return -x%1;}).bindto('fgY')(function(_){return imageAspectRatio('./image/grass_sideview.png').fmap(function(ratio){return 1-STD.aspect_ratio/ratio;});}).call(function($){return n_fullScaledImage('./image/grass_sideview.png')(1)($.fgX)($.fgY);}).bind(function($){return n_fullScaledImage('./image/grass_sideview.png')(1)($.fgX+1-0.001)($.fgY);});};var trigger_wingflap=randomSeedIO.fmap(evalProcess(randomElem(STD.audio_wingflaps))).bind(playSFX);var trigger_gameover=randomSeedIO.fmap(evalProcess(randomElem(STD.audio_meows))).bind(playSFX);